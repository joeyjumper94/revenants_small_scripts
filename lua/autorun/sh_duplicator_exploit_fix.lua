users_can_arm_dupes=true--remove this line if you want to block people with the usergroup of "user" from arming dupes

local func=function()
	if CLIENT then
		concommand.Remove("dupe_arm")
		concommand.Add("dupe_arm",function(ply,cmd,arg)
			if !arg[1] then return end
			local dupe=engine.OpenDupe(arg[1])
			if !dupe then
				MsgN("Error loading dupe.. (",arg[1],")")
				return
			elseif #dupe>64000 && !game.SinglePlayer() then
				ply:ChatPrint("That dupe is too large to spawn in multiplayer!")
				return
			elseif hook.Run("CanTool",ply,ply:GetEyeTrace(),"duplicator")==false then
				ply:ChatPrint("why arm a dupe if you can't spawn it?")
				return
			else
				local can,reason=hook.Run("CanArmDupe",ply,ply:GetEyeTrace(),"duplicator")
				if can==false then
					ply:ChatPrint(reason || "you cannot arm dupes")
					return
				end
			end
			local uncompressed=util.Decompress(dupe.data,5242880)
			if !uncompressed then
				MsgN("Couldn't decompress dupe!")
				return
			end
			local Dupe=util.JSONToTable(uncompressed)
			if !istable(Dupe) then return end
			if !istable(Dupe.Constraints) then return end
			if !istable(Dupe.Entities) then return end
			if !isvector(Dupe.Mins) then return end
			if !isvector(Dupe.Maxs) then return end
			net.Start("ArmDupe")
			net.WriteUInt(dupe.data:len(),32)
			net.WriteData(dupe.data,dupe.data:len())
			net.SendToServer()
		end,nil,"Arm a dupe",{ FCVAR_DONTRECORD})
		return
	end
	local LastDupeArm=0
	net.Receive("ArmDupe",function(len,client)
		if hook.Run("CanTool",client,client:GetEyeTrace(),"duplicator")==false then
			client:PrintMessage(HUD_PRINTTALK,"why arm a dupe if you can't spawn it?")
			return
		end
		if LastDupeArm>CurTime() then ServerLog(tostring(client).." tried to arm a dupe too quickly!\n") return end
		LastDupeArm=CurTime()+1
		ServerLog(tostring(client).." is arming a dupe.\n")
		local length=net.ReadUInt(32)
		local data=net.ReadData(length)
		if !IsValid(client) then return end
		if hook.Run("CanTool",client,client:GetEyeTrace(),"duplicator")==false then
			client:PrintMessage(HUD_PRINTTALK,"why arm a dupe if you can't spawn it?")
			return
		else
			local can,reason=hook.Run("CanArmDupe",client,client:GetEyeTrace(),"duplicator")
			if can==false then
				client:PrintMessage(HUD_PRINTTALK,reason || "you cannot arm dupes")
				return
			end
		end
		local uncompressed=util.Decompress(data,5242880)
		if !uncompressed then
			MsgN("Couldn't decompress dupe!")
			return
		end
		local Dupe=util.JSONToTable(uncompressed)
		if !istable(Dupe) then return end
		if !istable(Dupe.Constraints) then return end
		if !istable(Dupe.Entities) then return end
		if !isvector(Dupe.Mins) then return end
		if !isvector(Dupe.Maxs) then return end
		client.CurrentDupeArmed=true
		client.CurrentDupe=Dupe
		client:ConCommand("gmod_tool duplicator")
		net.Start("CopiedDupe")
		net.WriteUInt(0,1)
		net.Send(client)
	end)
end
hook.Add("Initialize","ArmDupe",func)
if GAMEMODE && GAMEMODE.Config || player.GetAll()[1] then func() end
hook.Add("CanArmDupe","ArmDupe",function(ply,trace,tool)
-	if !users_can_arm_dupes && ply:GetUserGroup()=="user" then
		return false,"users are NOT allowed to arm dupes"
	end
	for k,weapon in pairs(ply:GetWeapons()) do
		if weapon:GetClass()=="gmod_tool" then
			return
		end
	end
	return false,"get a toolgun before trying to arm a dupe"
end)
